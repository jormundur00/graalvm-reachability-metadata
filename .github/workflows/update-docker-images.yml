name: "Sync Docker Image Tags"

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  update-images:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "Replace Docker image tags everywhere"
        run: |
          # fetch main so we can get the old FROM lines
          git fetch origin main

          # get old FROM lines from main branch in Dockerfiles inside allowed directory
          OLD_LINES=$(git grep '^FROM ' origin/main -- tests/tck-build-logic/src/main/resources/allowed-docker-images | sed 's/^FROM //')
          
          # get new FROM lines from PR branch
          NEW_LINES=$(git grep '^FROM ' HEAD -- tests/tck-build-logic/src/main/resources/allowed-docker-images | sed 's/^FROM //')

          # debug
          echo "OLD_LINES=$OLD_LINES"
          echo "NEW_LINES=$NEW_LINES"

          # replace all occurrences across repo
          paste <(echo "$OLD_LINES") <(echo "$NEW_LINES") | while read OLD NEW; do
            if [[ -n "$OLD" && -n "$NEW" ]]; then
              echo "Replacing $OLD â†’ $NEW"
              grep -rl "$OLD" . | xargs sed -i "s|$OLD|$NEW|g" || true
            fi
          done

          # commit and push back to Dependabot branch if there are changes
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Sync Docker image tags across repo"
            git push origin HEAD
          else
            echo "No changes to commit"
          fi
