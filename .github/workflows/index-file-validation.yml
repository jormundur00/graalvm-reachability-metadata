name: "Validate index.json files"

on:
  pull_request:

jobs:
  validate-json:
    name: "üìã Validate changed JSON files"
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: "‚òÅÔ∏è Checkout repository"
        uses: actions/checkout@v4

      - name: "üîé Detect relevant file changes"
        id: filter
        uses: ./.github/actions/detect-file-changes
        with:
          file-patterns: |
            - 'metadata/index.json'
            - 'metadata/*/*/index.json'
            - 'tests/src/index.json'
            - 'tests/src/*/*/*/index.json'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup Python"
        if: steps.filter.outputs.changed == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: "Install validation tools"
        if: steps.filter.outputs.changed == 'true'
        run: |
          pip install jq check-jsonschema

      - name: "Check that the changed index.json files conform to their schemas"
        if: steps.filter.outputs.changed == 'true'
        run: |
          set -e
          
          # Treat changed_files as a proper array
          FILES=(${{ steps.filter.outputs.changed_files }})
          
          # Track failures
          FAILURES=()
          
          for FILE in "${FILES[@]}"; do
        
            # Determine schema for each file
            if [[ "$FILE" == "metadata/index.json" ]]; then
              SCHEMA="schemas/metadata-root-index-schema-v1.0.0.json"
            elif [[ "$FILE" == metadata/*/*/index.json ]]; then
              SCHEMA="schemas/metadata-library-index-schema-v1.0.0.json"
            elif [[ "$FILE" == "tests/src/index.json" ]]; then
              SCHEMA="schemas/tests-root-index-schema-v1.0.0.json"
            elif [[ "$FILE" == tests/src/*/*/*/index.json ]]; then
              SCHEMA="schemas/tests-project-index-schema-v1.0.0.json"
            else
              echo "‚ÑπÔ∏è Skipping: $FILE (no schema mapping)"
              continue
            fi
          
            echo "üîç Validating $FILE using $SCHEMA"
          
            # Step 1: Check JSON well-formedness
            if ! jq -e . "$FILE" >/dev/null; then
              echo "‚ùå $FILE is not valid JSON"
              FAILURES+=("$FILE (invalid JSON)")
              continue
            fi
          
            # Step 2: Validate against schema
            if ! check-jsonschema --schemafile "$SCHEMA" "$FILE"; then
              FAILURES+=("$FILE (schema validation failed)")
              continue
            fi
          
            echo "‚úÖ $FILE validated successfully"
          done
          
          # Fail at the end if any errors occurred
          if [ ${#FAILURES[@]} -ne 0 ]; then
            echo "::error ::Some files failed validation:"
          for f in "${FAILURES[@]}"; do
            echo "::error ::  $f"
          done
            exit 1
          fi
