name: "Validate metadata JSON files"

on:
  pull_request:

jobs:
  validate-json:
    name: "üìã Validate changed JSON files"
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: "‚òÅÔ∏è Checkout repository"
        uses: actions/checkout@v4

      - name: "üîé Detect relevant file changes"
        id: filter
        uses: ./.github/actions/detect-file-changes
        with:
          file-patterns: |
            - 'metadata/**/index.json'
            - 'tests/src/**/index.json'
            - 'library-and-framework-list.json'
            - 'schemas/*.json'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup Python"
        if: steps.filter.outputs.changed == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: "Install validation tools"
        if: steps.filter.outputs.changed == 'true'
        run: |
          pip install jq check-jsonschema

      - name: "Validate JSON files"
        if: steps.filter.outputs.changed == 'true'
        run: |
          set -e

          echo "::group::Changed JSON files"
          echo "${{ steps.filter.outputs.changed_files }}"
          echo "::endgroup::"

          # Split changed_files into array
          IFS=$'\n' read -r -d '' -a FILES <<< "${{ steps.filter.outputs.changed_files }}"

          for FILE in "${FILES[@]}"; do

            # Determine schema for each file
            if [[ "$FILE" == "metadata/index.json" ]]; then
              SCHEMA="schemas/metadata-root-index-schema-v1.0.0.json"
            elif [[ "$FILE" == metadata/*/*/index.json ]]; then
              SCHEMA="schemas/metadata-library-index-schema-v1.0.0.json"
            elif [[ "$FILE" == metadata/*/*/*/index.json ]]; then
              SCHEMA="schemas/metadata-version-index-schema-v1.0.0.json"
            elif [[ "$FILE" == "tests/src/index.json" ]]; then
              SCHEMA="schemas/tests-root-index-schema-v1.0.0.json"
            elif [[ "$FILE" == tests/src/*/index.json ]]; then
              SCHEMA="schemas/tests-project-index-schema-v1.0.0.json"
            elif [[ "$FILE" == "library-and-framework-list.json" ]]; then
              SCHEMA="schemas/library-and-framework-list-schema-v1.0.0.json"
            else
              echo "‚ÑπÔ∏è Skipping: $FILE (no schema mapping)"
              continue
            fi

            echo "üîç Validating $FILE using $SCHEMA"

            # Step 1: Check JSON well-formedness
            jq -e . "$FILE" >/dev/null || {
              echo "‚ùå $FILE is not valid JSON"
              exit 1
            }

            # Step 2: Validate against schema
            check-jsonschema --schemafile "$SCHEMA" "$FILE"

            echo "‚úÖ $FILE validated successfully"
          done
