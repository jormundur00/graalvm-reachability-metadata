name: "Minimal PAT Permission Test"

on:
  workflow_dispatch:

jobs:
  test_pat_pr_creation:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Needed for push/checkout
      pull-requests: write  # Needed for gh pr create/close

    env:
      # Exposes your PAT to the run step via the GH_TOKEN environment variable
      GH_TOKEN: ${{ secrets.REPO_PAT }}

    steps:
      # 1. Checkout the repository (Essential to make the directory a Git repo)
      - name: "☁️ Checkout repository"
        uses: actions/checkout@v4
        with:
          # Use the PAT for HTTPS authentication during checkout
          token: ${{ secrets.REPO_PAT }}
          fetch-depth: 0 # Required for git push later

      - name: "✏️ Create and Clean Up PR"
        run: |
          # Use a unique branch name to prevent conflicts
          BRANCH_NAME="test-pat-branch-$(date +%s)"
          git config --local user.email "jormundur00@gmail.com"
          git config --local user.name "jormundur00"          
          echo "--- Testing PR creation with REPO_PAT ---"
          
          # A. Create a dummy change and commit it locally
          git checkout -b $BRANCH_NAME
          echo "Test commit for $BRANCH_NAME" > test_pat_file.txt
          git add test_pat_file.txt
          git commit -m "Test commit: PAT check"
          
          # B. Push the new branch using the authenticated token
          git push -u origin $BRANCH_NAME
          
          # C. Create the Pull Request (This verifies the token's pull-requests:write permission)
          PR_URL=$(gh pr create \
            --title "[PAT Test] Successful Token Check" \
            --body "PR created successfully by token." \
            --base ${{ github.ref_name }} \
            --head $BRANCH_NAME \
            --json url -q ".url")

          echo "✅ Successfully created PR: $PR_URL"

          # D. Clean up
          echo "--- Cleaning up ---"
          gh pr close $BRANCH_NAME
          git push origin --delete $BRANCH_NAME
          echo "Cleanup complete. PR closed and branch deleted."
