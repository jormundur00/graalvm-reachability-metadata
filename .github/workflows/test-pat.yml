name: "Hybrid PAT/GITHUB_TOKEN Test"

on:
  workflow_dispatch:

jobs:
  test_hybrid_pr_creation:
    runs-on: ubuntu-latest

    # 1. GITHUB_TOKEN permissions (for git push)
    permissions:
      contents: write       # Essential for git push
      pull-requests: write  # Needed for gh pr create/close
      issues: write         # Needed for labels/assignees

    # Define the custom PAT token for the 'gh' CLI only
    env:
      CUSTOM_PR_TOKEN: ${{ secrets.REPO_PAT }}

    steps:
      # 1. Checkout using the default GITHUB_TOKEN (Secure and easy)
      - name: "☁️ Checkout repository (using GITHUB_TOKEN)"
        uses: actions/checkout@v4
        with:
          # Use the default token which is implicitly authorized by the 'permissions' block
          fetch-depth: 0

      # 2. Commit and Push using the default GITHUB_TOKEN authentication
      - name: "Git Commit and Push Branch (as github-actions[bot])"
        run: |
          BRANCH_NAME="test-hybrid-branch-$(date +%s)"
          
          # Configure identity as the default GitHub Actions bot
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          # Create and commit the change
          git checkout -b $BRANCH_NAME
          echo "Hybrid commit for $BRANCH_NAME" > test_hybrid_file.txt
          git add test_hybrid_file.txt
          git commit -m "Hybrid commit: Push by default bot"
          
          # Push the new branch. Uses GITHUB_TOKEN for authentication.
          git push -u origin $BRANCH_NAME
          
          echo "Created and pushed branch: $BRANCH_NAME" >> $GITHUB_ENV

      # 3. Create PR using the custom PAT
      - name: "✏️ Create PR (using custom PAT)"
        # Note: We pass the CUSTOM_PR_TOKEN as GH_TOKEN for this step only
        env:
          GH_TOKEN: ${{ env.CUSTOM_PR_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --title "[Hybrid Test] PR by Custom Bot" \
            --body "Branch pushed by default bot, PR created by custom token." \
            --base ${{ github.ref_name }} \
            --head ${{ env.BRANCH_NAME }} \
            --label "hybrid-test" \
            --json url -q ".url")

          echo "✅ Successfully created PR by custom token: $PR_URL" >> $GITHUB_STEP_SUMMARY
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

      # 4. Clean up (Optional, but good)
      - name: "D. Clean up"
        # Use the custom token for closing the PR and deleting the branch
        env:
          GH_TOKEN: ${{ env.CUSTOM_PR_TOKEN }}
        if: always()
        run: |
          echo "--- Cleaning up ---"
          gh pr close ${{ env.BRANCH_NAME }}
          git push origin --delete ${{ env.BRANCH_NAME }}
          echo "Cleanup complete."
