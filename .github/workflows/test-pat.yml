name: "Hybrid PAT/GITHUB_TOKEN Test (Open PR)"

on:
  workflow_dispatch:

jobs:
  test_hybrid_pr_creation:
    runs-on: ubuntu-latest

    # GITHUB_TOKEN permissions: Used for checkout, push, and setting job context
    permissions: write-all
    # Define the custom PAT token for the 'gh' CLI only
    env:
      CUSTOM_PR_TOKEN: ${{ secrets.REPO_PAT }}

    steps:
      # 1. Checkout using the default GITHUB_TOKEN
      - name: "☁️ Checkout repository (using GITHUB_TOKEN)"
        uses: actions/checkout@v4
        with:
          # Uses the default token for HTTPS
          fetch-depth: 0

      # 2. Commit and Push using the default GITHUB_TOKEN authentication
      - name: "Git Commit and Push Branch (as github-actions[bot])"
        run: |
          # Use a unique branch name
          BRANCH_NAME="test-hybrid-branch-$(date +%s)"
          
          # Configure identity as the default GitHub Actions bot for the commit
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          # Create and commit the change
          git checkout -b $BRANCH_NAME
          echo "Hybrid commit for $BRANCH_NAME" > test_hybrid_file.txt
          git add test_hybrid_file.txt
          git commit -m "Hybrid commit: Push by default bot"
          
          # Push the new branch. Authentication uses the GITHUB_TOKEN implicit in the runner.
          git push -u origin $BRANCH_NAME
          
          # Pass the branch name to subsequent steps
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      # 3. Create PR using the custom PAT
      - name: "✏️ Create PR (using custom PAT)"
        # Note: We pass the CUSTOM_PR_TOKEN as GH_TOKEN for this step only
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # The gh pr create command prints the new PR's URL to stdout.
          # We capture that URL using the 'tail' command to get the last line of output.
          PR_URL=$(gh pr create \
            --title "[Hybrid Test] PR by Custom Bot (Manual Review Required)" \
            --body "Branch pushed by default bot, PR created by custom token." \
            --base ${{ github.ref_name }} \
            --head ${{ env.BRANCH_NAME }} \
            --label "enhancement" \
            --assignee "jormundur00" \
            | tail -n 1)

          echo "✅ Successfully created PR by custom token: $PR_URL"
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV
      # The cleanup step (D) has been completely removed.
