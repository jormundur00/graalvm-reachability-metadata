name: "PAT Permission Test"

on:
  workflow_dispatch: # Allows manual triggering from the Actions tab

jobs:
  test_permissions:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for checkout and git push
      pull-requests: write # Needed for gh pr create
      issues: write # Needed for labels/assignees (if testing that)

    env:
      # Use the secret name that holds your PAT
      GH_TOKEN: ${{ secrets.REPO_PAT }}

    steps:
      - name: Install GitHub CLI
        run: |
          # The runner has 'gh' installed, but this ensures it's available
          sudo apt-get update && sudo apt-get install -y gh

      - name: Verify Token Permissions
        run: |
          # 1. Test basic repository access (equivalent to 'git clone/push')
          # This command attempts to fetch the repo using the token.
          echo "--- Testing Repository Access ---"
          git clone https://x-oauth-basic:${GH_TOKEN}@github.com/${{ github.repository }} temp_repo
          rm -rf temp_repo

          # 2. Test Pull Request creation capability
          # This is the crucial test. It tries to create a PR without any complex dependencies.
          echo "--- Testing gh pr create ---"
          
          # Create a dummy branch and commit
          git checkout -b test-pat-branch
          echo "Test commit $(date)" > TEST_FILE
          git add TEST_FILE
          git commit -m "Test commit for PAT permission check"
          
          # Push the new branch using the token
          git push -u origin test-pat-branch
          
          # Create a dummy PR
          PR_URL=$(gh pr create \
            --title "[PAT Test] PR from token" \
            --body "This PR tests the permissions of the REPO_PAT" \
            --base main \
            --head test-pat-branch \
            --label "test-pat-check" \
            --assignee ${{ github.actor }} \
            --draft \
            --json url -q ".url")

          echo "Successfully created dummy PR: $PR_URL"

          # 3. Clean up (Optional, but recommended)
          echo "--- Cleaning up ---"
          gh pr close test-pat-branch
          git push origin --delete test-pat-branch
