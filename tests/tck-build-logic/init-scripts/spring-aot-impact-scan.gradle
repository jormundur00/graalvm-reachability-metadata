/*
 * Copyright and related rights waived via CC0
 *
 * You should have received a copy of the CC0 legalcode along with this
 * work. If not, see <http://creativecommons.org/publicdomain/zero/1.0/>.
 */
import org.gradle.api.Project

allprojects {
    tasks.register('__internalImpactScan') {
        doLast {
            // Only consider projects that actually have native tests
            if (!(tasks.names.contains('nativeTest') || tasks.names.contains('nativeAppTest'))) {
                return
            }

            // Accept a comma-separated list of versionless coordinates via -PimpactCoordinatesList,
            // and keep backward compatibility with single -PimpactCoordinates
            def listProp = gradle.startParameter.projectProperties.get('impactCoordinatesList')
            def singleProp = gradle.startParameter.projectProperties.get('impactCoordinates')

            Set<String> targets = new LinkedHashSet<>()
            if (listProp != null) {
                listProp.toString().split(',').each { s ->
                    def v = s.trim()
                    if (!v.isEmpty()) targets.add(v)
                }
            }
            if (singleProp != null) {
                def v = singleProp.toString().trim()
                if (!v.isEmpty()) targets.add(v)
            }
            if (targets.isEmpty()) {
                return
            }

            // Resolve only selected classpath configurations to keep the scan fast
            def candidateConfNames = [
                'runtimeClasspath',
                'testRuntimeClasspath',
                'nativeTestRuntimeClasspath',
                'nativeAppTestRuntimeClasspath'
            ]
            def existingConfNames = candidateConfNames.findAll { configurations.names.contains(it) }
            def configs = existingConfNames
                    .collect { configurations.named(it).get() }
                    .findAll { it.canBeResolved }

            // Scan resolved components (including transitives) for any GA in the target set
            boolean match = false
            try {
                match = configs.any { conf ->
                    try {
                        return conf.incoming.resolutionResult.allComponents.any { comp ->
                            def m = comp.moduleVersion
                            if (m == null) return false
                            def ga = "${m.group}:${m.name}"
                            return targets.contains(ga)
                        }
                    } catch (Throwable ignored) {
                        return false
                    }
                }
            } catch (Throwable ignored) {
                match = false
            }

            if (match) {
                println "IMPACT_MATCH:${project.path}"
            }
        }
    }
}
